USE LAB_2;
GO

CREATE TABLE DIADIEM_PHG (
    MAPHG NCHAR(10) NOT NULL,
    DIADIEM NVARCHAR(15) NOT NULL
);

CREATE TABLE PHONGBAN (
    TENPHG NVARCHAR(15) NOT NULL,
    MAPHG NCHAR(10) PRIMARY KEY NOT NULL,
    TRPHG NVARCHAR(10) NOT NULL,
    NG_NHANCHUC DATE NOT NULL,
);

CREATE TABLE DEAN (
    TENDA NVARCHAR(15) NOT NULL,
    MADA NCHAR(10) NOT NULL,
    DDIEM_DA NVARCHAR(15) NOT NULL,
    PHONG INT NOT NULL,
);

CREATE TABLE CONGVIEC (
    MADA NCHAR(10) NOT NULL,
    STT INT NOT NULL,
    TEN_CONG_VIEC NVARCHAR(30) NOT NULL,
);

CREATE TABLE PHANCONG (
    MA_NVIEN NCHAR(10) NOT NULL,
    MADA NCHAR(10) NOT NULL,
    STT INT NOT NULL,
	THOIGIAN FLOAT NOT NULL
);

CREATE TABLE NHANVIEN (
    HONV NVARCHAR(15) NOT NULL,
    TENLOT NVARCHAR(15) NOT NULL,
    TENNV NVARCHAR(15) NOT NULL,
    MANV NCHAR(10) PRIMARY KEY NOT NULL,
    NGSINH DATE NOT NULL,
    DCHI NVARCHAR(30) NOT NULL,
    PHAI NVARCHAR(10) NOT NULL,
    LUONG FLOAT NOT NULL,
    MA_NQL NCHAR(10) NULL,
    PHG NVARCHAR(10) NOT NULL,
);

CREATE TABLE THANNHAN(
	MANV NCHAR(10) NOT NULL,
	TENTN NVARCHAR(15) NOT NULL,
	PHAI NVARCHAR(3) NOT NULL, 
	NGSINH DATE NOT NULL,
	QUANHE NVARCHAR(20) NOT NULL
);


INSERT INTO NHANVIEN(HONV, TENLOT, TENNV, MANV, NGSINH, DCHI, PHAI, LUONG, MA_NQL, PHG) VALUES
('DINH', 'BA', 'TIEN', '009', '1960-11-02', '119 CONG QUYNH, TP HCM', 'NAM', 30000, '005', '5'),
('NGUYEN', 'THANH', 'TUNG', '005', '1962-08-20', '222 NGUYEN VAN CU, TP HCM', 'NAM', 40000, '006', '5'),
('BUI', 'NGOC', 'HANG', '007', '1954-11-03', '332 NGUYEN THAI HOC, TP HCM', 'NAM', 25000, '001', '4'),
('LE', 'QUYNH', 'NHU', '001', '1967-01-02', '291 HO VAN HUE, TP HCM', 'NU', 43000, '006', '4'),
('NGUYEN', 'MANH', 'HUNG', '004', '1967-04-03', '95 BA RIA, VUNG TAU', 'NAM', 38000, '005', '5'),
('TRAN', 'THANH', 'TAN', '003', '1957-04-05', '34 MAI THI LU, TP HCM', 'NAM', 25000, '005', '5'),
('TRAN', 'HONG', 'QUANG', '008', '1967-01-09', '80 LE HONG PHONG, TP HCM', 'NAM', 25000, '001', '4'),
('PHAM', 'VAN', 'VINH', '006', '1965-01-01', '45 TRUNG VUONG, HA NOI', 'NU', 55000, NULL, '1');

INSERT INTO PHONGBAN(TENPHG, MAPHG, TRPHG, NG_NHANCHUC) VALUES
('NGIEN CUU', '5', '005', '1978-05-22'),
('DIEU HANH', '4', '008', '1985-01-01'),
('QUAN LY', '1', '006', '1971-06-19');

INSERT INTO THANNHAN(MANV, TENTN, PHAI, NGSINH, QUANHE) VALUES
('005', 'TRINH', 'NU', '1976-04-05', 'CON GAI'),
('005', 'KHANG', 'NAM', '1973-10-25', 'CON TRAI'),
('005', 'PHUONG', 'NU', '1948-05-03', 'VO CHONG'),
('001', 'MINH', 'NAM', '1932-02-29', 'VO CHONG'),
('009', 'TIEN', 'NAM', '1978-01-01', 'CON TRAI'),
('009', 'CHAU', 'NU', '1978-12-30', 'CON GAI'),
('009', 'PHUONG', 'NU', '1957-05-05', 'VO CHONG');

INSERT INTO DEAN(TENDA, MADA, DDIEM_DA, PHONG) VALUES
('SAN PHAM X', '1', 'VUNG TAU', 5),
('SAN PHAM Y', '2', 'NHA TRANG', 5),
('SAN PHAM Z', '3', 'TP HCM', 5),
('TIN HOC HOA', '10', 'HA NOI', 4),
('CAP QUANG', '20', 'TH HCM', 1),
('DAO TAO', '30', 'HA NOI', 4);

INSERT INTO DIADIEM_PHG(MAPHG, DIADIEM) VALUES
('1', N'TP HCM'),
('4', N'HA NOI'),
('5', N'TAU'),
('5', N'NHA TRANG'),
('5', N'TP HCM');

INSERT INTO PHANCONG(MA_NVIEN, MADA, STT, THOIGIAN) VALUES
('009', '1', 1, 32),
('009', '2', 2, 8),
('004', '3', 1, 40),
('003', '1', 2, 20.0),
('003', '2', 1, 20.0),
('008', '10', 1, 35),
('008', '30', 2, 5),
('001', '30', 1, 20),
('001', '20', 1, 15),
('006', '20', 1, 30),
('005', '3', 1, 10),
('005', '10', 2, 10),
('005', '20', 1, 10),
('007', '30', 2, 30),
('007', '10', 2, 10);

INSERT INTO CONGVIEC(MADA, STT, TEN_CONG_VIEC) VALUES
('1', 1, 'THIET KE SAN PHAM X'),
('1', 2, 'THU NGHIEM SAN PHAM X'),
('2', 1, 'SAN XUAT SAN PHAM X'),
('2', 2, 'QUANG CAO SAN PHAM Y'),
('3', 1, 'KHUYEN MAI SAN PHAM Z'),
('10', 1, 'TIN HOC HOA PHONG NHAN SU'),
('10', 2, 'TIN HOC HOA PHONG KINH DOANH'),
('20', 1, 'LAP DAT CAP QUANG'),
('30', 1, 'DAO TAO NHAN VIEN MARKETING'),
('30', 2, 'DAO TAO CHUYEN VIEN THIET KE');


--Chương trình tính diện tích, chu vi hình chữ nhật khi biết chiều dài và chiều rộng
/*
Chu vi (C) = (dai + rong ) * 2
Dien tich (S) = dai * rong
*/
BEGIN
	DECLARE @DAI FLOAT, @RONG FLOAT, @CHU_VI FLOAT, @DIEN_TICH FLOAT
	SET @DAI = 2
	SET @RONG = 5
	SET @CHU_VI = (@DAI + @RONG) * 2
	SET @DIEN_TICH = @DAI * @RONG

	SELECT @CHU_VI AS 'CHU VI', @DIEN_TICH AS 'DIEN TICH'
END

-- Y1
BEGIN
	DECLARE @MAX_LUONG FLOAT
	SET @MAX_LUONG = (SELECT MAX(LUONG) FROM NHANVIEN)
	SELECT * FROM NHANVIEN WHERE LUONG = @MAX_LUONG
END


BEGIN
	DECLARE @NHANVIEN TABLE(
		HONV NVARCHAR(15) NOT NULL,
		TENLOT NVARCHAR(15) NOT NULL,
		TENNV NVARCHAR(15) NOT NULL,
		MANV NCHAR(10) PRIMARY KEY NOT NULL,
		NGSINH DATE NOT NULL,
		DCHI NVARCHAR(30) NOT NULL,
		PHAI NVARCHAR(10) NOT NULL,
		LUONG FLOAT NOT NULL,
		MA_NQL NCHAR(10) NULL,
		PHG NVARCHAR(10) NOT NULL
	);

	DECLARE @DIADIEM_PHG TABLE(
		MAPHG NCHAR(10) NOT NULL,
		DIADIEM NVARCHAR(15) NOT NULL
	);

	DECLARE @PHONGBAN TABLE(
		TENPHG NVARCHAR(15) NOT NULL,
		MAPHG NCHAR(10) PRIMARY KEY NOT NULL,
		TRPHG NVARCHAR(10) NOT NULL,
		NG_NHANCHUC DATE NOT NULL
	);

	DECLARE @DEAN TABLE(
		TENDA NVARCHAR(15) NOT NULL,
		MADA NCHAR(10) NOT NULL,
		DDIEM_DA NVARCHAR(15) NOT NULL,
		PHONG INT NOT NULL
	);

	DECLARE @CONGVIEC TABLE(
		MADA NCHAR(10) NOT NULL,
		STT INT NOT NULL,
		TEN_CONG_VIEC NVARCHAR(30) NOT NULL
	)

	DECLARE @PHANCONG TABLE(
		MA_NVIEN NCHAR(10) NOT NULL,
		MADA NCHAR(10) NOT NULL,
		STT INT NOT NULL,
		THOIGIAN FLOAT NOT NULL
	);

	DECLARE @THANNHAN TABLE(
		MANV NCHAR(10) NOT NULL,
		TENTN NVARCHAR(15) NOT NULL,
		PHAI NVARCHAR(3) NOT NULL, 
		NGSINH DATE NOT NULL,
		QUANHE NVARCHAR(20) NOT NULL
	);
	
	INSERT INTO @NHANVIEN(HONV, TENLOT, TENNV, MANV, NGSINH, DCHI, PHAI, LUONG, MA_NQL, PHG) VALUES
	('DINH', 'BA', 'TIEN', '009', '1960-11-02', '119 CONG QUYNH, TP HCM', 'NAM', 30000, '005', '5'),
	('NGUYEN', 'THANH', 'TUNG', '005', '1962-08-20', '222 NGUYEN VAN CU, TP HCM', 'NAM', 40000, '006', '5'),
	('BUI', 'NGOC', 'HANG', '007', '1954-11-03', '332 NGUYEN THAI HOC, TP HCM', 'NAM', 25000, '001', '4'),
	('LE', 'QUYNH', 'NHU', '001', '1967-01-02', '291 HO VAN HUE, TP HCM', 'NU', 43000, '006', '4'),
	('NGUYEN', 'MANH', 'HUNG', '004', '1967-04-03', '95 BA RIA, VUNG TAU', 'NAM', 38000, '005', '5'),
	('TRAN', 'THANH', 'TAN', '003', '1957-04-05', '34 MAI THI LU, TP HCM', 'NAM', 25000, '005', '5'),
	('TRAN', 'HONG', 'QUANG', '008', '1967-01-09', '80 LE HONG PHONG, TP HCM', 'NAM', 25000, '001', '4'),
	('PHAM', 'VAN', 'VINH', '006', '1965-01-01', '45 TRUNG VUONG, HA NOI', 'NU', 55000, NULL, '1');

	INSERT INTO @PHONGBAN(TENPHG, MAPHG, TRPHG, NG_NHANCHUC) VALUES
	('NGIEN CUU', '5', '005', '1978-05-22'),
	('DIEU HANH', '4', '008', '1985-01-01'),
	('QUAN LY', '1', '006', '1971-06-19');

	INSERT INTO @THANNHAN(MANV, TENTN, PHAI, NGSINH, QUANHE) VALUES
	('005', 'TRINH', 'NU', '1976-04-05', 'CON GAI'),
	('005', 'KHANG', 'NAM', '1973-10-25', 'CON TRAI'),
	('005', 'PHUONG', 'NU', '1948-05-03', 'VO CHONG'),
	('001', 'MINH', 'NAM', '1932-02-29', 'VO CHONG'),
	('009', 'TIEN', 'NAM', '1978-01-01', 'CON TRAI'),
	('009', 'CHAU', 'NU', '1978-12-30', 'CON GAI'),
	('009', 'PHUONG', 'NU', '1957-05-05', 'VO CHONG');

	INSERT INTO @DEAN(TENDA, MADA, DDIEM_DA, PHONG) VALUES
	('SAN PHAM X', '1', 'VUNG TAU', 5),
	('SAN PHAM Y', '2', 'NHA TRANG', 5),
	('SAN PHAM Z', '3', 'TP HCM', 5),
	('TIN HOC HOA', '10', 'HA NOI', 4),
	('CAP QUANG', '20', 'TH HCM', 1),
	('DAO TAO', '30', 'HA NOI', 4);

	INSERT INTO @DIADIEM_PHG(MAPHG, DIADIEM) VALUES
	('1', N'TP HCM'),
	('4', N'HA NOI'),
	('5', N'TAU'),
	('5', N'NHA TRANG'),
	('5', N'TP HCM');

	INSERT INTO @PHANCONG(MA_NVIEN, MADA, STT, THOIGIAN) VALUES
	('009', '1', 1, 32),
	('009', '2', 2, 8),
	('004', '3', 1, 40),
	('003', '1', 2, 20.0),
	('003', '2', 1, 20.0),
	('008', '10', 1, 35),
	('008', '30', 2, 5),
	('001', '30', 1, 20),
	('001', '20', 1, 15),
	('006', '20', 1, 30),
	('005', '3', 1, 10),
	('005', '10', 2, 10),
	('005', '20', 1, 10),
	('007', '30', 2, 30),
	('007', '10', 2, 10);

	INSERT INTO @CONGVIEC(MADA, STT, TEN_CONG_VIEC) VALUES
	('1', 1, 'THIET KE SAN PHAM X'),
	('1', 2, 'THU NGHIEM SAN PHAM X'),
	('2', 1, 'SAN XUAT SAN PHAM X'),
	('2', 2, 'QUANG CAO SAN PHAM Y'),
	('3', 1, 'KHUYEN MAI SAN PHAM Z'),
	('10', 1, 'TIN HOC HOA PHONG NHAN SU'),
	('10', 2, 'TIN HOC HOA PHONG KINH DOANH'),
	('20', 1, 'LAP DAT CAP QUANG'),
	('30', 1, 'DAO TAO NHAN VIEN MARKETING'),
	('30', 2, 'DAO TAO CHUYEN VIEN THIET KE');

	-- Y2
	DECLARE @LUONGTRUNGBINH FLOAT;
	SELECT @LUONGTRUNGBINH = AVG(LUONG)
	FROM @NHANVIEN
	WHERE PHG = '5';
	SELECT HONV, TENLOT, TENNV
	FROM @NHANVIEN
	WHERE PHG = '5' AND LUONG > @LUONGTRUNGBINH;

	-- Y3
	SELECT PB.TENPHG, COUNT(NV.MANV) AS SoLuongNhanVien
	FROM @PHONGBAN PB
	INNER JOIN @NHANVIEN NV ON PB.MAPHG = NV.PHG
	GROUP BY PB.TENPHG
	HAVING AVG(NV.LUONG) > 30000;

	-- Y4
	SELECT PB.TENPHG, COUNT(DA.MADA) AS SoLuongDeAn
	FROM @PHONGBAN PB
	LEFT JOIN @DEAN DA ON PB.MAPHG = DA.PHONG
	GROUP BY PB.TENPHG;

END
